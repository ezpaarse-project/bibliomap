# bibliomap

Bibliomap is a tool for real-time viewing in the browser localised usage events generated by [ezPAARSE](https://github.com/ezpaarse-project/ezpaarse).

How could it be useful ?
  * For real-time monitoring your ezproxy EC consultations 
  * For helping ezpaarse adoption in your institution.
  * And just for fun !

![anim](https://cloud.githubusercontent.com/assets/328244/19802257/11855392-9d03-11e6-9338-e35893ecddfc.gif)

[Demonstration on the CNRS subscribed electronic ressources usage statistics](http://bibliomap.inist.fr/)

## Usage options

### Expo mode

In expo mode, the description popup will automatically show and hide at determined intervals. To activate it, add `expo` or `e` in the querystring. By default, the popup will be shown for **1 minute**, then hidden for **10 minutes**. To define custom intervals, `expo` should take two numbers separated by a comma. The first one is the time shown, the second is the time hidden. Times are defined in **seconds**.

Examples:
  - http://bibliomap.inist.fr?expo (activates default expo mode: 1min shown / 10 min hidden)
  - http://bibliomap.inist.fr?e (the same but with a shortcut)  
  - http://bibliomap.inist.fr?expo=20,120 (activates customized expo mode: 20 sec shown / 120 sec hidden)  

## Technical architecture

Bibliomap uses these softwares:
  * [bibliomap-harvester](https://github.com/ezpaarse-project/bibliomap-harvester) for real-time listening lines of log comming from ezproxys
  * [bibliomap-enricher](https://github.com/ezpaarse-project/bibliomap-enricher) listening for bibliomap-harvester data, sending it to ezpaarse and sending the result to you this bibliomap
  * [bibliomap-viewer](https://github.com/ezpaarse-project/bibliomap-viewer) for the front end web interface showing ezPAARSE EC's in real time thanks to websocket protocol
  * [Log.io](http://logio.org/) protocol for all the communication between these scripts

<p align="center">
<img src="https://docs.google.com/drawings/d/1bkxEEBL1kLzH76dkIYFzspYHOVajDjQHCijU3mxJLnM/pub?w=694&h=519" />
</p>

## Prerequisites

  * Docker and docker-compose

  * Load the configuration file which define your project settings (setup_*.sh)

## Installation and running a quick demo

```bash
# Clone the repository
git clone https://github.com/ezpaarse-project/bibliomap.git
cd bibliomap

# Load one configuration file
source ./setup_cnrs.sh 
# Or
source ./setup_istex.sh

# Start the tool
npm start
```

Then browse to http://127.0.0.1:50197

## Developers

## Installation for developing

```bash
# Clone all the required repositories
git clone https://github.com/ezpaarse-project/bibliomap.git
cd bibliomap
git clone https://github.com/ezpaarse-project/bibliomap-harvester.git
git clone https://github.com/ezpaarse-project/bibliomap-enricher.git
git clone https://github.com/ezpaarse-project/bibliomap-viewer.git

# Load one configuration file
source ./setup_cnrs.sh 
# Or
source ./setup_istex.sh

# Install dependencies & Start the tool
npm run install
npm run start-debug
```

Then browse to http://127.0.0.1:50197

Whenever you want you can git pull all the git repositories using one command:
```
npm run pull
```


### Upgrade

To upgrade to the latest version of [bibliomap-harvester](https://github.com/ezpaarse-project/bibliomap-harvester), [bibliomap-enricher](https://github.com/ezpaarse-project/bibliomap-enricher), and [bibliomap-viewer](https://github.com/ezpaarse-project/bibliomap-viewer) in the docker-compose.yml, just git clone all of these into your bibliomap/ folder (see just above) and run this command:

```
npm version patch
```

### BiblioMap Player

BiblioMap now has a replay mode: provide it with log files and it will play in real time. The replay mode features a time multiplier, which makes it times faster to have a quicker preview of what happened during that day.

__How to use the replay mode?__

You will need to specify some special variables in your configuration file: 

```bash
export REPLAY_FILE_PATHS='example.csv'
export REPLAY_FIRST_DATE="2020-03-08"
export REPLAY_START_TIME="06:00:00"
export REPLAY_MULTIPLIER=2
export REPLAY_MODE=true
export REPLAY_DURATION=1
```

* __REPLAY_FILE_PATHS__: Paths of the files you want to play. 
    - Files should be located at __bibliomap/sevices/enricher/data/replay_files__.
    - __All files should be from the same day__.
    - The list must be separated with commas.
    - The player can read log files (.log), EC files (.csv) and works with compressed  files (.gz).
* __REPLAY_START_DATE__: The date at which you want the player to start at. It must be using the __standard ISO 8601 format__. Starts the day of the first log if undefined.
* __REPLAY_START_TIME__: The time at which you want the player to start at. It must be using the __standard ISO 8601 format__. Starts at midnight if undefined.
* __REPLAY_MULTIPLIER__: How many times faster you want the player to be. __WARNING__: A multiplier too big can make the program or the browser crash.
* __REPLAY_MODE__: Boolean specifying if BiblioMap should be in replay mode. To not use the player mode, making it undefined works as well as setting it to false.
* __REPLAY_DURATION__: The number of days of the replay (1 if undefined).

After writing these variables in the file, you should source it:
```bash
source ./setup_example.sh
```